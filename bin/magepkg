#!/usr/bin/env php
<?php

// Make sure the script was invoked via CLI.
if (PHP_SAPI != 'cli') {
    echo 'Warning: Magento Packager must be invoked via the CLI version of PHP.' . PHP_EOL;
    exit(1);
}

// Find the autoloader.
$relativePaths = [
    // Path when testing from git clone.
    '../vendor/autoload.php',
    // Path when installed with Composer.
    '../../../autoload.php',
];
$loaded = false;
foreach ($relativePaths as $path) {
    if (is_file($filename = __DIR__ . "/{$path}")) {
        require $filename;
        $loaded = true;
        break;
    }
}

// Check if requiring the autoloader succeeded.
if (!$loaded) {
    echo 'Error: Magento Packager not installed correctly.' . PHP_EOL;
    exit(1);
}

use AmeenRoss\MagentoPackager\Packager;

// Process CLI arguments.
$arguments = getopt('', [
    'input:',
    'output:'
    'version:',
]);

// Check if input file was given.
if (empty($arguments['input'])) {
    echo 'Error: missing input filename.' . PHP_EOL;
    exit(1);
} else {
    // Use STDIN when `-` was given as filename.
    $input = ($arguments['input'] == '-') ? 'php://stdin' : $arguments['input'];
}

// Check that STDIN is not a TTY.
if (posix_isatty($input)) {
    echo "Error: can't use a TTY as input. Please pipe a raw tarball." . PHP_EOL;
    exit(1);
}

// Get default metadata from magepkg.xml file, if it exists.
if (file_exists('magepkg.xml')) {
    $metadata = new SimpleXMLElement('magepkg.xml', 0, true);
}

// Create packager instance.
$packager = new Packager($input, $arguments['output'], @$metadata);
